# ğŸ“š LINE @ æé†’ç³»çµ± - å®Œæ•´æ•™å­¸æ–‡ä»¶

## ğŸ¯ ç³»çµ±ç°¡ä»‹

é€™æ˜¯ä¸€å€‹è‡ªå‹•åŒ–ç³»çµ±ï¼Œå¯ä»¥ï¼š
- ç›£æ§ LINE ç¾¤çµ„ä¸­çš„ @ æåŠ
- è¨˜éŒ„è¢«æåŠçš„äººå“¡è³‡æ–™
- æä¾›ç¾è§€çš„å‰å°ä»‹é¢æŸ¥çœ‹çµ±è¨ˆè³‡æ–™

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹åœ–

```
LINE ç¾¤çµ„ â†’ LINE Bot â†’ Webhook â†’ Flask å¾Œç«¯ â†’ SQLite è³‡æ–™åº«
                                    â†“
                              å‰ç«¯ä»‹é¢é¡¯ç¤º
```

## ğŸ“ å°ˆæ¡ˆæª”æ¡ˆçµæ§‹

```
å®¢æˆ¶æé†’ç³»çµ±/
â”œâ”€â”€ app_simple.py          # ä¸»è¦æ‡‰ç”¨ç¨‹å¼ï¼ˆå¾Œç«¯ï¼‰
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ index.html         # å‰å°ä»‹é¢
â”‚   â””â”€â”€ test.html          # æ¸¬è©¦é é¢
â”œâ”€â”€ requirements.txt       # Python å¥—ä»¶æ¸…å–®
â”œâ”€â”€ wsgi.py               # é›²ç«¯éƒ¨ç½²å…¥å£
â”œâ”€â”€ start_app.py          # å•Ÿå‹•è…³æœ¬
â”œâ”€â”€ render.yaml           # Render éƒ¨ç½²è¨­å®š
â””â”€â”€ README.md             # åŸºæœ¬èªªæ˜
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½è§£æ

### 1. LINE Bot ç›£æ§ (@æåŠåµæ¸¬)

**æª”æ¡ˆ**: `app_simple.py` ä¸­çš„ `handle_message()` å‡½æ•¸

```python
def handle_message(event):
    """è™•ç† LINE è¨Šæ¯äº‹ä»¶"""
    # æª¢æŸ¥æ˜¯å¦ç‚ºç¾¤çµ„è¨Šæ¯
    if 'source' in event and 'groupId' in event['source']:
        message_text = event['message']['text']
        
        # æª¢æŸ¥æ˜¯å¦åŒ…å« @ æåŠ
        if '@' in message_text:
            # è§£æè¢«æåŠçš„ä½¿ç”¨è€…
            mentioned_users = parse_mentions(message_text, group_id)
```

**åŠŸèƒ½èªªæ˜**:
- ç›£è½ LINE ç¾¤çµ„è¨Šæ¯
- æª¢æŸ¥è¨Šæ¯ä¸­æ˜¯å¦åŒ…å« `@` ç¬¦è™Ÿ
- è‡ªå‹•è§£æè¢«æåŠçš„ä½¿ç”¨è€…åç¨±

### 2. æåŠè§£æ (@åç¨±æå–)

**æª”æ¡ˆ**: `app_simple.py` ä¸­çš„ `parse_mentions()` å‡½æ•¸

```python
def parse_mentions(text, group_id):
    """è§£æè¨Šæ¯ä¸­çš„ @ æåŠ"""
    mention_patterns = [
        r'@(\w+)',              # @è‹±æ–‡åç¨±
        r'@([\u4e00-\u9fff]+)', # @ä¸­æ–‡åç¨±
        r'@([^\s]+)',           # @ä»»ä½•éç©ºç™½å­—ç¬¦
    ]
```

**åŠŸèƒ½èªªæ˜**:
- ä½¿ç”¨æ­£å‰‡è¡¨é”å¼åŒ¹é… @ å¾Œé¢çš„åç¨±
- æ”¯æ´ä¸­æ–‡ã€è‹±æ–‡ã€ç‰¹æ®Šå­—ç¬¦
- é¿å…é‡è¤‡è¨˜éŒ„åŒä¸€å€‹æåŠ

### 3. è³‡æ–™å„²å­˜ (SQLite è³‡æ–™åº«)

**æª”æ¡ˆ**: `app_simple.py` ä¸­çš„ `save_mentions()` å‡½æ•¸

```python
def save_mentions(mentioned_users, group_id, message, message_id):
    """å„²å­˜æåŠè¨˜éŒ„åˆ°è³‡æ–™åº«"""
    cursor.execute('''
        INSERT INTO mentioned_users 
        (user_id, user_name, group_id, message, mentioned_at)
        VALUES (?, ?, ?, ?, ?)
    ''')
```

**è³‡æ–™åº«çµæ§‹**:
```sql
CREATE TABLE mentioned_users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,        -- ä½¿ç”¨è€… ID
    user_name TEXT,               -- ä½¿ç”¨è€…åç¨±
    group_id TEXT,                -- ç¾¤çµ„ ID
    message TEXT,                 -- å®Œæ•´è¨Šæ¯å…§å®¹
    mentioned_at TIMESTAMP,       -- æåŠæ™‚é–“
    message_id TEXT               -- è¨Šæ¯ ID
);
```

### 4. æ™ºèƒ½åç¨±åˆä½µ

**æª”æ¡ˆ**: `app_simple.py` ä¸­çš„ `is_similar_name()` å‡½æ•¸

```python
def is_similar_name(name1, name2):
    """æª¢æŸ¥å…©å€‹åç¨±æ˜¯å¦ç›¸ä¼¼ï¼ˆå¯èƒ½æ˜¯åŒä¸€å€‹äººï¼‰"""
    # å®Œå…¨åŒ¹é…
    if name1 == name2:
        return True
    
    # åŒ…å«é—œä¿‚ï¼šæ—è© æ™¨ åŒ…å«åœ¨ æ—è© æ™¨Sunny ä¸­
    if name1 in name2 or name2 in name1:
        return True
```

**åŠŸèƒ½èªªæ˜**:
- è‡ªå‹•è­˜åˆ¥åŒä¸€äººçš„ä¸åŒåç¨±
- åˆä½µé¡¯ç¤ºï¼š`æ—è© æ™¨Sunny-äºè·¯ (3å€‹åç¨±)`
- é¿å…é‡è¤‡çµ±è¨ˆ

### 5. API ç«¯é» (è³‡æ–™æä¾›)

**æª”æ¡ˆ**: `app_simple.py` ä¸­çš„ API è·¯ç”±

```python
@app.route("/api/statistics")
def get_statistics():
    """ç²å–çµ±è¨ˆè³‡æ–™"""
    # ç¸½æåŠæ¬¡æ•¸ã€ç”¨æˆ¶æ•¸é‡ã€ç¾¤çµ„æ•¸é‡ç­‰

@app.route("/api/mentioned-users")
def get_mentioned_users():
    """ç²å–æåŠè¨˜éŒ„"""
    # æœ€è¿‘çš„æåŠè¨˜éŒ„åˆ—è¡¨
```

**API ç«¯é»**:
- `GET /api/statistics` - çµ±è¨ˆè³‡æ–™
- `GET /api/mentioned-users` - æåŠè¨˜éŒ„
- `POST /webhook` - LINE Bot æ¥æ”¶ç«¯

### 6. å‰ç«¯ä»‹é¢ (ä½¿ç”¨è€…ä»‹é¢)

**æª”æ¡ˆ**: `templates/index.html`

**åŠŸèƒ½ç‰¹è‰²**:
- éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆæ‰‹æ©Ÿã€é›»è…¦éƒ½é©ç”¨ï¼‰
- å³æ™‚çµ±è¨ˆè³‡æ–™é¡¯ç¤º
- è‡ªå‹•è³‡æ–™æ›´æ–°ï¼ˆæ¯30ç§’ï¼‰
- ç¾è§€çš„å¡ç‰‡å¼ä½ˆå±€

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. æœ¬åœ°é–‹ç™¼

```bash
# å®‰è£ä¾è³´å¥—ä»¶
pip install -r requirements.txt

# è¨­å®šç’°å¢ƒè®Šæ•¸
cp env_example.txt .env
# ç·¨è¼¯ .env æª”æ¡ˆï¼Œå¡«å…¥ LINE Bot è¨­å®š

# å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
python start_app.py
```

### 2. é›²ç«¯éƒ¨ç½² (Render)

```bash
# 1. åˆå§‹åŒ– Git å€‰åº«
git init
git add .
git commit -m "Initial commit"

# 2. æ¨é€åˆ° GitHub
git remote add origin https://github.com/æ‚¨çš„ç”¨æˆ¶å/æ‚¨çš„å€‰åº«å.git
git push -u origin main

# 3. åœ¨ Render ä¸Šéƒ¨ç½²
# - å‰å¾€ render.com
# - å»ºç«‹ Web Service
# - é€£æ¥ GitHub å€‰åº«
# - è¨­å®šç’°å¢ƒè®Šæ•¸
```

## ğŸ“Š è³‡æ–™æµç¨‹

### 1. æåŠç™¼ç”Ÿæ™‚

```
ç”¨æˆ¶åœ¨ LINE ç¾¤çµ„è¼¸å…¥: "@å°æ˜ è«‹å¹«å¿™"
    â†“
LINE Bot æ¥æ”¶è¨Šæ¯
    â†“
æª¢æŸ¥æ˜¯å¦åŒ…å« @ ç¬¦è™Ÿ
    â†“
è§£æä½¿ç”¨è€…åç¨±: "å°æ˜"
    â†“
å„²å­˜åˆ°è³‡æ–™åº«
    â†“
å›è¦†ç¢ºèªè¨Šæ¯
```

### 2. æŸ¥çœ‹çµ±è¨ˆæ™‚

```
ç”¨æˆ¶è¨ªå•å‰å°ä»‹é¢
    â†“
å‰ç«¯å‘¼å« API: /api/statistics
    â†“
å¾Œç«¯æŸ¥è©¢è³‡æ–™åº«
    â†“
æ™ºèƒ½åˆä½µç›¸ä¼¼åç¨±
    â†“
è¿”å› JSON è³‡æ–™
    â†“
å‰ç«¯é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
```

## ğŸ” é—œéµç¨‹å¼ç¢¼è§£æ

### æ­£å‰‡è¡¨é”å¼ (Regex)

```python
r'@(\w+)'              # åŒ¹é… @è‹±æ–‡åç¨±
r'@([\u4e00-\u9fff]+)' # åŒ¹é… @ä¸­æ–‡åç¨±
r'@([^\s]+)'           # åŒ¹é… @ä»»ä½•éç©ºç™½å­—ç¬¦
```

**èªªæ˜**:
- `@` - åŒ¹é… @ ç¬¦è™Ÿ
- `(\w+)` - åŒ¹é…ä¸€å€‹æˆ–å¤šå€‹è‹±æ–‡å­—æ¯ã€æ•¸å­—ã€åº•ç·š
- `([\u4e00-\u9fff]+)` - åŒ¹é…ä¸€å€‹æˆ–å¤šå€‹ä¸­æ–‡å­—ç¬¦
- `([^\s]+)` - åŒ¹é…ä¸€å€‹æˆ–å¤šå€‹éç©ºç™½å­—ç¬¦

### è³‡æ–™åº«æŸ¥è©¢

```python
# çµ±è¨ˆç¸½æåŠæ¬¡æ•¸
cursor.execute('SELECT COUNT(*) FROM mentioned_users')

# çµ±è¨ˆä¸é‡è¤‡ç”¨æˆ¶æ•¸
cursor.execute('SELECT COUNT(DISTINCT user_id) FROM mentioned_users')

# ç²å–æœ€å¸¸è¢«æåŠçš„ç”¨æˆ¶
cursor.execute('''
    SELECT user_name, COUNT(*) as mention_count
    FROM mentioned_users
    GROUP BY user_name
    ORDER BY mention_count DESC
    LIMIT 10
''')
```

### å‰ç«¯ JavaScript

```javascript
// è¼‰å…¥çµ±è¨ˆè³‡æ–™
async function loadData() {
    const response = await fetch('/api/statistics');
    const data = await response.json();
    
    // æ›´æ–°é é¢é¡¯ç¤º
    document.getElementById('totalMentions').textContent = data.total_mentions;
}
```

## ğŸ› ï¸ è‡ªè¨‚åŠŸèƒ½

### 1. ä¿®æ”¹æåŠæ ¼å¼

å¦‚æœè¦æ”¯æ´å…¶ä»–æåŠæ ¼å¼ï¼Œä¿®æ”¹ `parse_mentions()` å‡½æ•¸ï¼š

```python
mention_patterns = [
    r'@(\w+)',              # ç¾æœ‰æ ¼å¼
    r'#(\w+)',              # æ–°å¢ # æ¨™ç±¤æ ¼å¼
    r'æåŠ(\w+)',           # æ–°å¢ä¸­æ–‡æåŠæ ¼å¼
]
```

### 2. æ·»åŠ æ–°çš„çµ±è¨ˆé …ç›®

åœ¨ `get_statistics()` å‡½æ•¸ä¸­æ·»åŠ ï¼š

```python
# æ–°å¢ï¼šæœ¬é€±æåŠæ¬¡æ•¸
cursor.execute('''
    SELECT COUNT(*) FROM mentioned_users 
    WHERE mentioned_at >= DATE('now', '-7 days')
''')
weekly_mentions = cursor.fetchone()[0]

return jsonify({
    # ç¾æœ‰è³‡æ–™...
    'weekly_mentions': weekly_mentions
})
```

### 3. ä¿®æ”¹å‰ç«¯æ¨£å¼

ç·¨è¼¯ `templates/index.html` ä¸­çš„ CSSï¼š

```css
.stats-card {
    background: #your-color;  /* ä¿®æ”¹é¡è‰² */
    border-radius: 10px;      /* ä¿®æ”¹åœ“è§’ */
}
```

## ğŸ› å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### 1. LINE Bot æ²’æœ‰å›æ‡‰

**æª¢æŸ¥é …ç›®**:
- Webhook URL æ˜¯å¦æ­£ç¢ºè¨­å®š
- ç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢º
- æœå‹™æ˜¯å¦æ­£åœ¨é‹è¡Œ

**è§£æ±ºæ–¹æ³•**:
```bash
# æª¢æŸ¥æœå‹™ç‹€æ…‹
heroku logs --tail  # å¦‚æœä½¿ç”¨ Heroku
# æˆ–æŸ¥çœ‹ Render æ—¥èªŒ
```

### 2. è³‡æ–™åº«éŒ¯èª¤

**æª¢æŸ¥é …ç›®**:
- è³‡æ–™åº«æª”æ¡ˆæ¬Šé™
- SQL èªæ³•æ˜¯å¦æ­£ç¢º

**è§£æ±ºæ–¹æ³•**:
```python
# é‡æ–°åˆå§‹åŒ–è³‡æ–™åº«
def init_db():
    conn = sqlite3.connect('line_data.db')
    cursor = conn.cursor()
    cursor.execute('DROP TABLE IF EXISTS mentioned_users')
    # é‡æ–°å»ºç«‹è¡¨æ ¼...
```

### 3. å‰ç«¯ç„¡æ³•è¼‰å…¥è³‡æ–™

**æª¢æŸ¥é …ç›®**:
- API ç«¯é»æ˜¯å¦æ­£å¸¸
- ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸

**è§£æ±ºæ–¹æ³•**:
```javascript
// æ·»åŠ éŒ¯èª¤è™•ç†
try {
    const response = await fetch('/api/statistics');
    if (!response.ok) {
        throw new Error('API éŒ¯èª¤');
    }
    const data = await response.json();
} catch (error) {
    console.error('è¼‰å…¥å¤±æ•—:', error);
}
```

## ğŸ“ˆ æ•ˆèƒ½å„ªåŒ–å»ºè­°

### 1. è³‡æ–™åº«å„ªåŒ–

```sql
-- æ·»åŠ ç´¢å¼•æå‡æŸ¥è©¢é€Ÿåº¦
CREATE INDEX idx_user_name ON mentioned_users(user_name);
CREATE INDEX idx_mentioned_at ON mentioned_users(mentioned_at);
```

### 2. å¿«å–æ©Ÿåˆ¶

```python
# æ·»åŠ ç°¡å–®çš„å¿«å–
from functools import lru_cache

@lru_cache(maxsize=128)
def get_statistics():
    # çµ±è¨ˆé‚è¼¯...
```

### 3. åˆ†é è¼‰å…¥

```python
@app.route("/api/mentioned-users")
def get_mentioned_users():
    page = request.args.get('page', 1, type=int)
    per_page = 20
    offset = (page - 1) * per_page
    
    cursor.execute('''
        SELECT * FROM mentioned_users
        ORDER BY mentioned_at DESC
        LIMIT ? OFFSET ?
    ''', (per_page, offset))
```

## ğŸ“ å­¸ç¿’é‡é»

### åˆå­¸è€…é‡é»ï¼š

1. **ç†è§£è³‡æ–™æµç¨‹**ï¼šå¾ LINE è¨Šæ¯åˆ°è³‡æ–™åº«å„²å­˜
2. **å­¸ç¿’ API è¨­è¨ˆ**ï¼šRESTful API çš„åŸºæœ¬æ¦‚å¿µ
3. **æŒæ¡å‰ç«¯å¾Œç«¯äº’å‹•**ï¼šJavaScript èˆ‡ Python çš„é…åˆ
4. **äº†è§£è³‡æ–™åº«æ“ä½œ**ï¼šSQL æŸ¥è©¢å’Œè³‡æ–™ç®¡ç†

### é€²éšå­¸ç¿’ï¼š

1. **æ­£å‰‡è¡¨é”å¼**ï¼šæ¨¡å¼åŒ¹é…å’Œæ–‡å­—è™•ç†
2. **é›²ç«¯éƒ¨ç½²**ï¼šCI/CD å’Œè‡ªå‹•åŒ–éƒ¨ç½²
3. **æ•ˆèƒ½å„ªåŒ–**ï¼šè³‡æ–™åº«ç´¢å¼•å’Œå¿«å–æ©Ÿåˆ¶
4. **éŒ¯èª¤è™•ç†**ï¼šç•°å¸¸è™•ç†å’Œæ—¥èªŒè¨˜éŒ„

## ğŸ“ æŠ€è¡“æ”¯æ´

å¦‚æœé‡åˆ°å•é¡Œï¼š

1. **æª¢æŸ¥æ—¥èªŒæª”æ¡ˆ**ï¼šæŸ¥çœ‹éŒ¯èª¤è¨Šæ¯
2. **ç¢ºèªç’°å¢ƒè¨­å®š**ï¼šæª¢æŸ¥ç’°å¢ƒè®Šæ•¸å’Œé…ç½®
3. **æ¸¬è©¦ API ç«¯é»**ï¼šä½¿ç”¨ Postman æˆ–ç€è¦½å™¨æ¸¬è©¦
4. **æŸ¥çœ‹å®˜æ–¹æ–‡ä»¶**ï¼šFlaskã€LINE Bot API æ–‡ä»¶

---

**ç¥æ‚¨å­¸ç¿’æ„‰å¿«ï¼** ğŸ‰ 