# 📚 LINE @ 提醒系統 - 完整教學文件

## 🎯 系統簡介

這是一個自動化系統，可以：
- 監控 LINE 群組中的 @ 提及
- 記錄被提及的人員資料
- 提供美觀的前台介面查看統計資料

## 🏗️ 系統架構圖

```
LINE 群組 → LINE Bot → Webhook → Flask 後端 → SQLite 資料庫
                                    ↓
                              前端介面顯示
```

## 📁 專案檔案結構

```
客戶提醒系統/
├── app_simple.py          # 主要應用程式（後端）
├── templates/
│   ├── index.html         # 前台介面
│   └── test.html          # 測試頁面
├── requirements.txt       # Python 套件清單
├── wsgi.py               # 雲端部署入口
├── start_app.py          # 啟動腳本
├── render.yaml           # Render 部署設定
└── README.md             # 基本說明
```

## 🔧 核心功能解析

### 1. LINE Bot 監控 (@提及偵測)

**檔案**: `app_simple.py` 中的 `handle_message()` 函數

```python
def handle_message(event):
    """處理 LINE 訊息事件"""
    # 檢查是否為群組訊息
    if 'source' in event and 'groupId' in event['source']:
        message_text = event['message']['text']
        
        # 檢查是否包含 @ 提及
        if '@' in message_text:
            # 解析被提及的使用者
            mentioned_users = parse_mentions(message_text, group_id)
```

**功能說明**:
- 監聽 LINE 群組訊息
- 檢查訊息中是否包含 `@` 符號
- 自動解析被提及的使用者名稱

### 2. 提及解析 (@名稱提取)

**檔案**: `app_simple.py` 中的 `parse_mentions()` 函數

```python
def parse_mentions(text, group_id):
    """解析訊息中的 @ 提及"""
    mention_patterns = [
        r'@(\w+)',              # @英文名稱
        r'@([\u4e00-\u9fff]+)', # @中文名稱
        r'@([^\s]+)',           # @任何非空白字符
    ]
```

**功能說明**:
- 使用正則表達式匹配 @ 後面的名稱
- 支援中文、英文、特殊字符
- 避免重複記錄同一個提及

### 3. 資料儲存 (SQLite 資料庫)

**檔案**: `app_simple.py` 中的 `save_mentions()` 函數

```python
def save_mentions(mentioned_users, group_id, message, message_id):
    """儲存提及記錄到資料庫"""
    cursor.execute('''
        INSERT INTO mentioned_users 
        (user_id, user_name, group_id, message, mentioned_at)
        VALUES (?, ?, ?, ?, ?)
    ''')
```

**資料庫結構**:
```sql
CREATE TABLE mentioned_users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,        -- 使用者 ID
    user_name TEXT,               -- 使用者名稱
    group_id TEXT,                -- 群組 ID
    message TEXT,                 -- 完整訊息內容
    mentioned_at TIMESTAMP,       -- 提及時間
    message_id TEXT               -- 訊息 ID
);
```

### 4. 智能名稱合併

**檔案**: `app_simple.py` 中的 `is_similar_name()` 函數

```python
def is_similar_name(name1, name2):
    """檢查兩個名稱是否相似（可能是同一個人）"""
    # 完全匹配
    if name1 == name2:
        return True
    
    # 包含關係：林詠晨 包含在 林詠晨Sunny 中
    if name1 in name2 or name2 in name1:
        return True
```

**功能說明**:
- 自動識別同一人的不同名稱
- 合併顯示：`林詠晨Sunny-亞路 (3個名稱)`
- 避免重複統計

### 5. API 端點 (資料提供)

**檔案**: `app_simple.py` 中的 API 路由

```python
@app.route("/api/statistics")
def get_statistics():
    """獲取統計資料"""
    # 總提及次數、用戶數量、群組數量等

@app.route("/api/mentioned-users")
def get_mentioned_users():
    """獲取提及記錄"""
    # 最近的提及記錄列表
```

**API 端點**:
- `GET /api/statistics` - 統計資料
- `GET /api/mentioned-users` - 提及記錄
- `POST /webhook` - LINE Bot 接收端

### 6. 前端介面 (使用者介面)

**檔案**: `templates/index.html`

**功能特色**:
- 響應式設計（手機、電腦都適用）
- 即時統計資料顯示
- 自動資料更新（每30秒）
- 美觀的卡片式佈局

## 🚀 部署流程

### 1. 本地開發

```bash
# 安裝依賴套件
pip install -r requirements.txt

# 設定環境變數
cp env_example.txt .env
# 編輯 .env 檔案，填入 LINE Bot 設定

# 啟動應用程式
python start_app.py
```

### 2. 雲端部署 (Render)

```bash
# 1. 初始化 Git 倉庫
git init
git add .
git commit -m "Initial commit"

# 2. 推送到 GitHub
git remote add origin https://github.com/您的用戶名/您的倉庫名.git
git push -u origin main

# 3. 在 Render 上部署
# - 前往 render.com
# - 建立 Web Service
# - 連接 GitHub 倉庫
# - 設定環境變數
```

## 📊 資料流程

### 1. 提及發生時

```
用戶在 LINE 群組輸入: "@小明 請幫忙"
    ↓
LINE Bot 接收訊息
    ↓
檢查是否包含 @ 符號
    ↓
解析使用者名稱: "小明"
    ↓
儲存到資料庫
    ↓
回覆確認訊息
```

### 2. 查看統計時

```
用戶訪問前台介面
    ↓
前端呼叫 API: /api/statistics
    ↓
後端查詢資料庫
    ↓
智能合併相似名稱
    ↓
返回 JSON 資料
    ↓
前端顯示統計資訊
```

## 🔍 關鍵程式碼解析

### 正則表達式 (Regex)

```python
r'@(\w+)'              # 匹配 @英文名稱
r'@([\u4e00-\u9fff]+)' # 匹配 @中文名稱
r'@([^\s]+)'           # 匹配 @任何非空白字符
```

**說明**:
- `@` - 匹配 @ 符號
- `(\w+)` - 匹配一個或多個英文字母、數字、底線
- `([\u4e00-\u9fff]+)` - 匹配一個或多個中文字符
- `([^\s]+)` - 匹配一個或多個非空白字符

### 資料庫查詢

```python
# 統計總提及次數
cursor.execute('SELECT COUNT(*) FROM mentioned_users')

# 統計不重複用戶數
cursor.execute('SELECT COUNT(DISTINCT user_id) FROM mentioned_users')

# 獲取最常被提及的用戶
cursor.execute('''
    SELECT user_name, COUNT(*) as mention_count
    FROM mentioned_users
    GROUP BY user_name
    ORDER BY mention_count DESC
    LIMIT 10
''')
```

### 前端 JavaScript

```javascript
// 載入統計資料
async function loadData() {
    const response = await fetch('/api/statistics');
    const data = await response.json();
    
    // 更新頁面顯示
    document.getElementById('totalMentions').textContent = data.total_mentions;
}
```

## 🛠️ 自訂功能

### 1. 修改提及格式

如果要支援其他提及格式，修改 `parse_mentions()` 函數：

```python
mention_patterns = [
    r'@(\w+)',              # 現有格式
    r'#(\w+)',              # 新增 # 標籤格式
    r'提及(\w+)',           # 新增中文提及格式
]
```

### 2. 添加新的統計項目

在 `get_statistics()` 函數中添加：

```python
# 新增：本週提及次數
cursor.execute('''
    SELECT COUNT(*) FROM mentioned_users 
    WHERE mentioned_at >= DATE('now', '-7 days')
''')
weekly_mentions = cursor.fetchone()[0]

return jsonify({
    # 現有資料...
    'weekly_mentions': weekly_mentions
})
```

### 3. 修改前端樣式

編輯 `templates/index.html` 中的 CSS：

```css
.stats-card {
    background: #your-color;  /* 修改顏色 */
    border-radius: 10px;      /* 修改圓角 */
}
```

## 🐛 常見問題與解決方案

### 1. LINE Bot 沒有回應

**檢查項目**:
- Webhook URL 是否正確設定
- 環境變數是否正確
- 服務是否正在運行

**解決方法**:
```bash
# 檢查服務狀態
heroku logs --tail  # 如果使用 Heroku
# 或查看 Render 日誌
```

### 2. 資料庫錯誤

**檢查項目**:
- 資料庫檔案權限
- SQL 語法是否正確

**解決方法**:
```python
# 重新初始化資料庫
def init_db():
    conn = sqlite3.connect('line_data.db')
    cursor = conn.cursor()
    cursor.execute('DROP TABLE IF EXISTS mentioned_users')
    # 重新建立表格...
```

### 3. 前端無法載入資料

**檢查項目**:
- API 端點是否正常
- 網路連線是否正常

**解決方法**:
```javascript
// 添加錯誤處理
try {
    const response = await fetch('/api/statistics');
    if (!response.ok) {
        throw new Error('API 錯誤');
    }
    const data = await response.json();
} catch (error) {
    console.error('載入失敗:', error);
}
```

## 📈 效能優化建議

### 1. 資料庫優化

```sql
-- 添加索引提升查詢速度
CREATE INDEX idx_user_name ON mentioned_users(user_name);
CREATE INDEX idx_mentioned_at ON mentioned_users(mentioned_at);
```

### 2. 快取機制

```python
# 添加簡單的快取
from functools import lru_cache

@lru_cache(maxsize=128)
def get_statistics():
    # 統計邏輯...
```

### 3. 分頁載入

```python
@app.route("/api/mentioned-users")
def get_mentioned_users():
    page = request.args.get('page', 1, type=int)
    per_page = 20
    offset = (page - 1) * per_page
    
    cursor.execute('''
        SELECT * FROM mentioned_users
        ORDER BY mentioned_at DESC
        LIMIT ? OFFSET ?
    ''', (per_page, offset))
```

## 🎓 學習重點

### 初學者重點：

1. **理解資料流程**：從 LINE 訊息到資料庫儲存
2. **學習 API 設計**：RESTful API 的基本概念
3. **掌握前端後端互動**：JavaScript 與 Python 的配合
4. **了解資料庫操作**：SQL 查詢和資料管理

### 進階學習：

1. **正則表達式**：模式匹配和文字處理
2. **雲端部署**：CI/CD 和自動化部署
3. **效能優化**：資料庫索引和快取機制
4. **錯誤處理**：異常處理和日誌記錄

## 📞 技術支援

如果遇到問題：

1. **檢查日誌檔案**：查看錯誤訊息
2. **確認環境設定**：檢查環境變數和配置
3. **測試 API 端點**：使用 Postman 或瀏覽器測試
4. **查看官方文件**：Flask、LINE Bot API 文件

---

**祝您學習愉快！** 🎉 